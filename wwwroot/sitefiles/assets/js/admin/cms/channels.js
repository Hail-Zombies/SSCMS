var $url="/cms/channels/channels",$urlUpdate=$url+"/actions/update",$urlDelete=$url+"/actions/delete",data=utils.init({siteId:utils.getQueryInt("siteId"),root:null,expandedChannelIds:[],indexNames:[],groupNames:[],channelTemplates:[],contentTemplates:[],defaultChannelTemplate:null,defaultContentTemplate:null,columns:null,commandsWidth:160,channelIds:[],filterText:"",filterIndexName:"",filterGroupName:"",appendPanel:!1,appendForm:null,editPanel:!1,form:null,editLinkTypes:[],editTaxisTypes:[],styles:[],siteUrl:null,isTemplateEditable:!1,deletePanel:!1,deleteForm:null,importPanel:!1,importForm:null,importUploadList:[]}),methods={runFormLayerImageUploadText:function(e,t,i){this.insertText(e,t,i)},runFormLayerImageUploadEditor:function(e,t){this.insertEditor(e,t)},runMaterialLayerImageSelect:function(e,t,i){this.insertText(e,t,i)},runFormLayerFileUpload:function(e,t,i){this.insertText(e,t,i)},runMaterialLayerFileSelect:function(e,t,i){this.insertText(e,t,i)},runFormLayerVideoUpload:function(e,t,i){this.insertText(e,t,i)},runMaterialLayerVideoSelect:function(e,t,i){this.insertText(e,t,i)},runEditorLayerImage:function(e,t){this.insertEditor(e,t)},insertText:function(e,t,i){(this.form[utils.getCountName(e)]||0)<=t&&(this.form[utils.getCountName(e)]=t),this.form[utils.getExtendName(e,t)]=i,this.form=_.assign({},this.form)},insertEditor:function(e,t){e||(e="Body"),t&&utils.getEditor(e).execCommand("insertHTML",t)},setRuleText:function(e,t){t?this.form.channelFilePathRule=e:this.form.contentFilePathRule=e},updateGroups:function(e,t){this.groupNames=e.groupNames,utils.success(t)},apiList:function(e,t){var i=this;utils.loading(this,!0),$api.get($url,{params:{siteId:this.siteId}}).then(function(n){var a=n.data;i.root=[a.channel],i.indexNames=a.indexNames,i.groupNames=a.groupNames,i.channelTemplates=a.channelTemplates,i.contentTemplates=a.contentTemplates,i.defaultChannelTemplate=i.channelTemplates.find(function(e){return e.defaultTemplate}),i.defaultContentTemplate=i.contentTemplates.find(function(e){return e.defaultTemplate}),i.columns=a.columns,i.commandsWidth=a.commandsWidth,i.isTemplateEditable=a.isTemplateEditable,i.expandedChannelIds=t||[i.siteId],i.editLinkTypes=a.linkTypes,i.editTaxisTypes=a.taxisTypes,i.siteUrl=a.siteUrl,e&&utils.success(e)}).catch(function(e){utils.error(e)}).then(function(){utils.loading(i,!1)})},apiGet:function(e){var t=this;utils.loading(this,!0),$api.get($url+"/"+this.siteId+"/"+e).then(function(e){var i=e.data;t.form=_.assign({},i.entity),t.form.groupNames||(t.form.groupNames=[]),t.styles=i.styles,t.form.filePath=i.filePath,t.form.channelFilePathRule=i.channelFilePathRule,t.form.contentFilePathRule=i.contentFilePathRule,t.editPanel=!0,utils.loadEditors(t.styles,t.form)}).catch(function(e){utils.error(e)}).then(function(){utils.loading(t,!1)})},apiAppend:function(){var e=this;utils.loading(this,!0),$api.post($url+"/actions/append",{siteId:this.siteId,parentId:this.appendForm.parentIds[this.appendForm.parentIds.length-1],channelTemplateId:this.appendForm.channelTemplateId,contentTemplateId:this.appendForm.contentTemplateId,isParentTemplates:this.appendForm.isParentTemplates,isIndexName:this.appendForm.isIndexName,channels:this.appendForm.channels}).then(function(t){var i=t.data;e.appendPanel=!1,e.apiList("栏目添加成功!",i)}).catch(function(t){utils.loading(e,!1),utils.error(t)})},apiUpdate:function(){var e=this;utils.loading(this,!0),$api.post($urlUpdate,this.form).then(function(t){var i=t.data;e.editPanel=!1,e.apiList("栏目编辑成功!",i)}).catch(function(t){utils.loading(e,!1),utils.error(t)})},apiDelete:function(){var e=this;utils.loading(this,!0),$api.post($urlDelete,this.deleteForm).then(function(t){var i=t.data;e.deletePanel=!1,e.apiList("栏目删除成功!",i)}).catch(function(t){utils.loading(e,!1),utils.error(t)})},apiImport:function(){var e=this;utils.loading(this,!0),$api.post($url+"/actions/import",{siteId:this.importForm.siteId,channelId:this.importForm.channelIds[this.importForm.channelIds.length-1],fileName:this.importForm.fileName,isOverride:this.importForm.isOverride}).then(function(t){var i=t.data;e.importPanel=!1,e.apiList("栏目导入成功!",i)}).catch(function(t){utils.loading(e,!1),utils.error(t)})},apiDrop:function(e,t,i){var n=this;utils.loading(this,!0),$api.post($url+"/actions/drop",{siteId:this.siteId,sourceId:e,targetId:t,dropType:i}).then(function(e){e.data;utils.success("栏目排序成功!")}).catch(function(e){utils.error(e)}).then(function(){utils.loading(n,!1)})},apiColumns:function(e){$api.post($url+"/actions/columns",{siteId:this.siteId,attributeNames:e}).then(function(e){e.data}).catch(function(e){utils.error(e)})},handleColumnsChange:function(){var e=_.filter(this.columns,function(e){return e.isList}),t=_.map(e,function(e){return e.attributeName});this.apiColumns(t)},btnSetClick:function(e,t,i){var n=utils.getCmsUrl("settingsCreateRuleLayerSet",{siteId:this.siteId,isChannel:t,channelId:e,rule:i});utils.openLayer({title:"构造",url:n,width:800,height:500})},getColumnWidth:function(e){return"Id"===e?80:"ChannelTemplateId"===e||"ContentTemplateId"===e?120:"IndexName"===e?120:180},getTemplate:function(e,t){var i=null;return(i=e?this.channelTemplates.find(function(e){return e.id===t}):this.contentTemplates.find(function(e){return e.id===t}))||(i=e?this.defaultChannelTemplate:this.defaultContentTemplate),i},getTemplateEditorUrl:function(e,t){return utils.getCmsUrl("templatesEditor",{siteId:this.siteId,templateId:t,templateType:e?"ChannelTemplate":"ContentTemplate",accessToken:$token})},btnEditAddGroupClick:function(){utils.openLayer({title:"新增栏目组",url:utils.getCommonUrl("groupChannelLayerAdd",{siteId:this.siteId}),width:500,height:300})},handleDrop:function(e,t,i,n){this.apiDrop(e.data.value,t.data.value,i)},allowDrop:function(e,t,i){return t.data.value!==this.siteId},allowDrag:function(e){return e.data.value!==this.siteId},getChannelUrl:function(e){return utils.getRootUrl("redirect",{siteId:this.siteId,channelId:e.value})},handleCheckChange(){this.channelIds=this.$refs.tree.getCheckedKeys()},btnCheckClick:function(e){-1!==this.channelIds.indexOf(e.value)?this.channelIds.splice(this.channelIds.indexOf(e.value),1):this.channelIds.push(e.value),this.$refs.tree.setCheckedKeys(this.channelIds)},filterNode:function(e,t){return!e||(e.channelName&&e.indexName&&e.groupName?(-1!==t.label.indexOf(e.channelName)||t.value+""===e.channelName)&&t.channel.indexName===e.indexName&&-1!==t.groupNames.indexOf(e.groupName):e.channelName&&e.indexName?(-1!==t.label.indexOf(e.channelName)||t.value+""===e.channelName)&&t.channel.indexName===e.indexName:e.channelName&&e.groupName?(-1!==t.label.indexOf(e.channelName)||t.value+""===e.channelName)&&-1!==t.groupNames.indexOf(e.groupName):e.indexName&&e.groupName?t.channel.indexName===e.indexName&&-1!==t.groupNames.indexOf(e.groupName):e.channelName?-1!==t.label.indexOf(e.channelName)||t.value+""===e.channelName:e.groupName?-1!==t.groupNames.indexOf(e.groupName):!e.indexName||t.channel.indexName===e.indexName)},btnCancelClick:function(){this.appendPanel=!1,this.deletePanel=!1,this.importPanel=!1,this.editPanel=!1},btnAppendClick:function(){this.appendForm={parentIds:[this.siteId],channelTemplateId:0,contentTemplateId:0,isParentTemplates:!0,isIndexName:!1,channels:""},this.appendPanel=!0},btnAppendSubmitClick:function(){var e=this;this.$refs.appendForm.validate(function(t){t&&e.apiAppend()})},btnEditClick:function(e){this.apiGet(e.value)},btnEditSubmitClick:function(){var e=this;this.$refs.editForm.validate(function(t){t&&e.apiUpdate()})},btnDeleteClick:function(e){this.deleteForm={siteId:this.siteId,channelId:e.value,label:e.label,channelName:null,deleteFiles:!1},this.deletePanel=!0},btnDeleteSubmitClick:function(){var e=this;this.$refs.deleteForm.validate(function(t){t&&(e.deleteForm.channelName==e.deleteForm.label?e.apiDelete():utils.error("请检查您输入的栏目名称是否正确"))})},btnImportClick:function(){this.importForm={siteId:this.siteId,channelIds:[this.siteId],fileName:null,isOverride:!0},this.importPanel=!0},btnTranslateClick:function(){location.href=utils.getCmsUrl("channelsTranslate",{siteId:this.siteId,channelIds:this.channelIds.join(","),returnUrl:location.href})},btnImportSubmitClick:function(){var e=this;this.$refs.importForm.validate(function(t){t&&e.apiImport()})},btnExportClick:function(){var e=this;utils.loading(this,!0),$api.post($url+"/actions/export",{siteId:this.siteId,channelIds:this.channelIds}).then(function(e){var t=e.data;window.open(t.value)}).catch(function(e){utils.error(e)}).then(function(){utils.loading(e,!1)})},btnSetGroupClick:function(){utils.openLayer({title:"设置栏目组",url:utils.getCmsUrl("channelsLayerGroup",{siteId:this.siteId,channelIds:this.channelIds.join(",")}),width:700,height:400})},btnSetTaxisClick:function(){utils.openLayer({title:"栏目排序",url:utils.getCmsUrl("channelsLayerTaxis",{siteId:this.siteId,channelIds:this.channelIds.join(",")}),width:500,height:260})},btnCreateClick:function(){utils.openLayer({title:"生成页面",url:utils.getCmsUrl("channelsLayerCreate",{siteId:this.siteId,channelIds:this.channelIds.join(",")}),width:500,height:260})},btnMenuClick:function(e,t){var i=utils.addQuery(e.link,{siteId:this.siteId,channelId:t.value});"_layer"==e.target?utils.openLayer({title:e.text,url:i,full:!0}):"_self"==e.target?location.href=i:"_parent"==e.target?parent.location.href=i:"_top"==e.target?top.location.href=i:"_blank"==e.target?window.open(i):utils.addTab(e.text,i)},uploadBefore(e){var t=-1!==e.name.indexOf(".zip",e.name.length-".zip".length);return t||utils.error("导入文件只能是 Zip 格式!"),t},uploadProgress:function(){utils.loading(this,!0)},uploadSuccess:function(e,t){this.loading&&this.loading.close(),this.importForm.fileName=e.value},uploadError:function(e){this.loading&&this.loading.close();var t=JSON.parse(e.message);utils.error(t.message)},btnLayerClick:function(e){var t={siteId:this.siteId};e.attributeName&&(t.attributeName=e.attributeName),e.no&&(t.no=e.no),e.contentId&&(t.contentId=e.contentId);var i={title:e.title,url:utils.getCommonUrl(e.name,t)};e.full||(i.width=e.width?e.width:700,i.height=e.height?e.height:500),utils.openLayer(i)},btnExtendAddClick:function(e){var t=this.form[utils.getCountName(e.attributeName)]+1;this.form[utils.getCountName(e.attributeName)]=t,this.form[utils.getExtendName(e.attributeName,t)]="",this.form=_.assign({},this.form)},btnExtendRemoveClick:function(e){var t=this.form[utils.getCountName(e.attributeName)];this.form[utils.getCountName(e.attributeName)]=t-1,this.form[utils.getExtendName(e.attributeName,t)]="",this.form=_.assign({},this.form)},btnExtendPreviewClick:function(e,t){for(var i=this.form[utils.getCountName(e)],n=[],a=0;a<=i;a++){var l=this.form[utils.getExtendName(e,a)];l=utils.getUrl(this.siteUrl,l),n.push({src:l})}layer.photos({photos:{start:t,data:n},anim:5})}},$vue=new Vue({el:"#main",data:data,methods:methods,watch:{filterText:function(e){this.$refs.tree.filter({channelName:e,indexName:this.filterIndexName,groupName:this.filterGroupName})},filterIndexName:function(e){this.$refs.tree.filter({channelName:this.filterText,indexName:e,groupName:this.filterGroupName})},filterGroupName:function(e){this.$refs.tree.filter({channelName:this.filterText,indexName:this.filterIndexName,groupName:e})}},created:function(){this.uploadUrl=$apiUrl+$url+"/actions/upload?siteId="+this.siteId,this.apiList()}});